# atac-seq-pipeline v. 1.0

Nextflow Pipeline for atac-seq data analysis.


## Development and maintenance

The pipeline was initially developed for the pbs cluster by Elin as part of the work done together with Michael Borg. 
Elin Axelsson-Ekker (elin.axelsson@gmi.oeaw.ac.at) is maintaining the pipeline. Please contact her for bug reports, new feature suggestions etc. 


### Note about version(s)

Version 1.0 represent a version close to the original pipeline (used by Mike) **PLEASE NOTE: the software versions and annotations are NOT the same as it was for the work of Mike (the current version uses mostly updated versions)**. Later version may include e.g. new features, changed output etc. But also a change in softwares and/or software version. With higher version, the coding will become more similar to other pipelines (to make maintaining/further developments as easy as possible).  


# About the atac-seq-pipeline

The folder contains two nextflow files (align.nf and main.nf). 

**The align.nf pipeline** takes demultiplexed unaligned bam files and performs the following steps: <br/>
1,  converts bam to fastq files and trims reads to set length <br/>
2,  removes adapter sequences using cutadapt <br/>
3,  aligns the reads using bowtie2 and saves the alignment logs.

**The main.nf pipeline** carries on using the aligned bam files generated by align.nf and performs the following: <br/>
1, Generates bam files that are filtered for quality and contains only uniquely mapped reads. <br/>
2, Generates bigwig files from the bam files in 1, <br/>
3, Merges the files from 1, so that all replicates are in one large bam file <br/>
4, Runs statistics on the large bam files from 3, <br/>
5, Using the stats from 4, the files from 3 are subsampled so that all conditions have the same read depth <br/>
6, Sorts the files from 5 <br/>
7, Generates bigwig files from the files generated in 6 <br/>
8, Calls macs2 on the files from 5 <br/>
9, Merges peaks using the macs2 output from 8 <br/>
10, Makes some plots using the peaks from 8 <br/>
11, Creates a gff file for rhe merged peaks <br/>
12, Counts reads in each merged peak <br/>
13, Counts reads in all narrow peaks <br/>
14, Runs deseq2 analysis on the merged peaks <br/>
15, Combines results from the different steps

# Files and Data needed


- Unaligned sequencing files (paired-ended , bam format)  



# Output files


**The align.nf pipeline**:

- aligned bam files
- bowtie2 logs
- cut adapt logs


**The main.nf pipeline** generates 7 subfolders:


- bam
- counts 
- deseq 
- ds_bam 
- fpkm  
- gff    
- macs2

## Recommended setup

### -1. Add Hinkskalle to singularity (one time only)

See [How to add Hinkskalle to singularity](#hinkskalle)

### 0. Start a new tmux session or attach to an existing (optional but useful)

See e.g. https://tmuxcheatsheet.com/ and section [Short intro to tmux](#tmux)


### 1. Clone the repo

From  e.g. *your user folder in the lab folder* do:

```
git clone https://ngs.vbcf.ac.at/repo/berger_pipelines/atac-seq-pipeline.git
```
you might be asked for user and password, use the ones from your **forskalle** account


### 2. Create a folder with links to the bam files

e.g:
```
mkdir -p bams
ln -s /groups/berger/Raw/demultiplexed/97009_AATGATAGGACCACCT_CDR8FANXX_1_20190821B_20190821.bam bams/
ln -s /groups/berger/Raw/demultiplexed/97010_TTGGCGCGTGGCTAGG_CDR8FANXX_1_20190821B_20190821.bam bams/
```    
As long as you use links and do not actually copy the files, this folder can be created in your user folder on the lab folder, e.g. in the ChIPseq_NF folder that you cloned or in the folder above. 

### 3. Create a design file called e.g. exp.tab

In this file write (with , as sep) one row per sample:

The name you want to use for the sample, the name of the aligned bam file (without the .bam extension!), the condition

E.g.:

Cond1_rep1, Cond1_rep1_aligned, cond1 <br/>
Cond1_rep2, Cond1_rep2_aligned, cond1 <br/>
Cond2_rep1, Cond2_rep1_aligned, cond2 <br/>
Cond2_rep2, Cond2_rep2_aligned, cond2 <br/>




### 4. Then load the following modules:

```
module load nextflow/19.04.0  #or higher if you prefer
module load singularity/X.X.X
```
**NOTE** On CBE, you can skip loading singularity   
**NOTE** if you are in a tmux session were this was already done, this step can be skipped!

### 5.  If you have not already, then go to the atac-seq-pipeline folder.

```
cd atac-seq-pipeline
```

## <a name="run"></a>How to run 


**Make sure you have:**
 1. completed the setup steps 
 2. that you are on the cluster with the correct modules loaded
 3. moved into the atac-seq-pipeline folder

To use the pipeline with the default settings 

    nextflow run align.nf -profile slurm --bams "/path/to/files/*.bam" -w /path/to/scratch/dir
    nextflow run main.nf -profile slurm --bams "/path/to/files/aligned/*.bam" --design "/path/to/exp.tab" -w /path/to/scratch/dir

Here the "/path/to/files/" is the path to the folder/file you created earlier. The "/path/to/files/aligned" is the path to the folder with the resulting aligned bam files from align.nf (by default: "results").The -w sets the path to where the pipeline should be run and where the intermediate files will be stored. **It should be on the scratch and not in the lab folder!**

**NOTE** that the files path needs to be within citation marks ("") otherwise nextflow will only use one bam file from the folder and not all.     


# Nextflow parameters 

If you open the file called align.nf or the file main.nf in the atac-seq-pipeline folder you will find, on the very top, a section called "Parameters". This section contains is a set of input information that is given to the pipeline. The parameters are run-specific, meaning that one can give different parameters for different datasets. However, some of the parameters here do not need to be changed!

## ALIGNMENT PIPELINE (align.nf)

**params.bams:** this is the path to the folder where you have your raw (demultiplexed) bam files followed by  '/\*.bam' which tells the pipeline to take all files with the .bam extension as input files (NB the folder should contain ONLY the bam files your are interested in). 

**params.read_length:** this the read length of the bam files with the shortest reads. By default it is set to 50 bp. If all your samples were sequences with e.g. 120 bp then you can/should set this parameter to 120 (or 0 - read on to learn why). If some of your samples were sequenced e.g. 50bp whereas other samples where longer, they you should set this to 50.  If you set the read_length parameter to 0, this means that the reads will not be trimmed down, meaning samples sequenced with 50bp will have 50pb reads and samples with e.g. 120 bp will have reads that are 120 bp long. **I recommend to set this parameter to the length of the shortest read length sample, even when all samples were sequenced to the same length.** 

**params.output:** the path where the aligned bam files will end up when the pipeline has finished. **I recommend NOT to change this parameter**.

**params.stats:** the path where the alignment logs will be saved to. 

**params.min_length:** this parameter is used by cutadapt. After removing adapter sequences, reads that are shorter than this are removed from the analysis. (Does not make sense to try to align reads that are just a few bp long)

**params.overlap:** this parameter is used by cutadapt. When identifying adapter sequences, this is the overlap required between the adapter sequence and the read.  **If this parameter is not set to 1, there will be a a dip in the aligned fragment distribution, so DO NOT CHANGE THIS unless you have really good reasons**. 

**params.A:** this parameter is used by cutadapt. It is the adaptor sequence that should be detected and cut away. The default is for Tn5 tagmentation used in atac-seq. **DO NOT CHANGE THIS unless you have really good reasons**

**params.a:** this parameter is used by cutadapt.  It is the adaptor sequence that should be detected and cut away. The default is for Tn5 tagmentation used in atac-seq. **DO NOT CHANGE THIS unless you have really good reasons**

**params.index:** this is the index that Bowtie2 will use to align the reads.

## MAIN PIPELINE (main.nf)

**params.design:**  The file with the experimental design.  **If you follow the 'recommended project setup', then the default path will work for you and you can leave it as it is.**<br/>

**params.macs_call:** The call passed to macs2.

**params.genome:** At the moment only Athaliana is available. For adding other organisms or annotation sets please contact me.

**params.bams:**  The path to the folder with the aligned bam files, followed by '/\*.bam' which tells the pipeline to take all files with the .bam extension as input files (NB the folder should contain ONLY the bam files your are interested in). **If you follow the 'recommended project setup', then the default path will work for you and you can leave it as it is.**<br/>

**params.quality:** The quality threshold for the alignment

**params.output:** The path to the folder where the results will end up when the pipeline has finished

**params.anno_distance:** Distance up and downstream from TSS to be considered when annotating peaks

**params.peak_merge_dist:** Peaks closer than this will be merged

**params.deseq_p:** The p-value threshold used in DESeq2 (only in plots)

**params.deseq_fc:** The fold change threshold used in DESeq2 (only in plots)

**params.bw_binsize:** Desired binsize for bigwig files


**More nextflow options:**

- to resume add -resume.   
- to run in background add -bg 



## <a name="hinkskalle"></a>How to adding Hinkskalle to singularity

As the pipeline uses containers from the ngs registry (aka "Hinkskalle"), you need to do the following (on the CBE cluster):

```
singularity remote add --no-login hinkskalle singularity.ngs.vbcf.ac.at
singularity remote use hinkskalle
```

**It's enough if you do this once.** The settings will then be saved a folder (.singularity) in your home directory and you do not need to worry about it any more. **UNLESS** you later change the remote registry ( singularity remote use <another registry> ). Then you have to re-run the last line before you start the pipeline.

**NOTE:** If you are using another cluster (e.g. outside of VBC ), you need to make sure Singularity (version 3.4 or higher) is installed and loaded BEFORE you add the hinklist registry. 


##  <a name="tmux"></a>Short intro to tmux

tmux is a very convent tool to use on the cluster. It has many benefits but some of the most obvious are:

1. It lets you set up an environment on the cluster that you can move in an out from as much you want. E.g. if you have a tmux session called ChIPseq_NF you can load the modules needed to run the pipeline (nextflow and singularity) **once** and then by re-attaching to this session the modules are already loaded.
2. Scripts that are running in the session will continue to run even if you logout from the cluster. 

See also e.g.  https://en.wikipedia.org/wiki/Tmux/

To start a new session type:

    tmux new -s atac

This will create a tmux session with the name atac and attach you to it. 

To detach from the session press *Ctrl* + *b* and then *d*

To attach to an existing session type 

    tmux a -t atac

This will put you into the existing session called atac. Note that the session needs to be created before you can re-attach to it.









